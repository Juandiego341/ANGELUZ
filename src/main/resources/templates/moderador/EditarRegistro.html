<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head th:replace="fragments/headerModerator :: headerModerator">
    <meta charset="UTF-8">
    <title>Editar Registro</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
<nav th:replace="fragments/headerModerator :: navbarModerator"></nav>

<div class="max-w-7xl mx-auto py-16 px-4 sm:px-7 lg:px-8">
    <h1 class="text-4xl font-bold text-gray-900 mb-4">Editar Registro de Cliente y Mascotas</h1>

    <div th:if="${successMessage}"
         class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
        <span class="block sm:inline" th:text="${successMessage}"></span>
    </div>
    <div th:if="${errorMessage}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"
         role="alert">
        <span class="block sm:inline" th:text="${errorMessage}"></span>
    </div>
    <div th:if="${warningMessage}"
         class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative mb-4" role="alert">
        <span class="block sm:inline" th:text="${warningMessage}"></span>
    </div>

    <form th:action="@{/moderador/EntradasYSalidas/editar/{id}(id=${entryForm.id})}"
          th:object="${entryForm}"
          method="post"
          class="space-y-6">

        <input type="hidden" name="_csrf" th:value="${_csrf?.token}"/>

        <section>
            <h2 class="text-2xl font-semibold mb-4">Datos del Propietario</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block mb-1 font-medium">Nombre</label>
                    <input type="text" th:field="*{nombrePropietario}" class="w-full border rounded px-3 py-2"/>
                </div>
                <div>
                    <label class="block mb-1 font-medium">Cédula</label>
                    <input type="text" th:field="*{cedulaCiudadania}" class="w-full border rounded px-3 py-2"/>
                </div>
                <div>
                    <label class="block mb-1 font-medium">Correo</label>
                    <input type="email" th:field="*{correo}" class="w-full border rounded px-3 py-2"/>
                </div>
                <div>
                    <label class="block mb-1 font-medium">Celular</label>
                    <input type="text" th:field="*{celular}" class="w-full border rounded px-3 py-2"/>
                </div>
                <div class="md:col-span-2">
                    <label class="block mb-1 font-medium">Servicio (¿Qué va a ser?)</label>
                    <input type="text" th:field="*{queVaASer}" class="w-full border rounded px-3 py-2"/>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-2xl font-semibold mb-4">Mascotas</h2>
            <div id="mascotas-container" class="space-y-6">
                <div th:each="mascota,iterStat : *{mascotas}" class="mascota-card border p-4 rounded-lg bg-gray-50">
                    <input type="hidden" th:field="*{mascotas[__${iterStat.index}__].id}"/>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block mb-1 font-medium">Nombre</label>
                            <input type="text" th:field="*{mascotas[__${iterStat.index}__].nombre}"
                                   class="w-full border rounded px-2 py-1"/>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">Tipo de Animal</label>
                            <select th:field="*{mascotas[__${iterStat.index}__].tipoAnimal}"
                                    class="tipo-animal-select w-full border rounded px-2 py-1">
                                <option value="">Seleccione</option>
                                <option value="Perro">Perro</option>
                                <option value="Gato">Gato</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">Raza</label>
                            <select th:field="*{mascotas[__${iterStat.index}__].raza}"
                                    class="raza-select w-full border rounded px-2 py-1"
                                    th:attr="data-selected=${mascota.raza}">
                                <option value="">Seleccione</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">Edad (años)</label>
                            <input type="number" th:field="*{mascotas[__${iterStat.index}__].edad}"
                                   class="w-full border rounded px-2 py-1"/>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">Peso (kg)</label>
                            <input type="number" step="0.01" th:field="*{mascotas[__${iterStat.index}__].peso}"
                                   class="w-full border rounded px-2 py-1"/>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">Sexo</label>
                            <select th:field="*{mascotas[__${iterStat.index}__].sexo}"
                                    class="w-full border rounded px-2 py-1">
                                <option value="">Seleccione</option>
                                <option value="Macho">Macho</option>
                                <option value="Hembra">Hembra</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">Microchip</label>
                            <input type="text" th:field="*{mascotas[__${iterStat.index}__].numeroMicrochip}"
                                   class="w-full border rounded px-2 py-1"/>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">Color y Marcas</label>
                            <input type="text" th:field="*{mascotas[__${iterStat.index}__].colorYMarcas}"
                                   class="w-full border rounded px-2 py-1"/>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1 font-medium">Necesidades especiales</label>
                            <input type="text" th:field="*{mascotas[__${iterStat.index}__].necesidadesEspeciales}"
                                   class="w-full border rounded px-2 py-1"/>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">Alimentación</label>
                            <input type="text"
                                   th:field="*{mascotas[__${iterStat.index}__].alimentacion}"
                                   class="w-full border rounded px-2 py-1"/>
                        </div>
                        <div>
                            <label class="block mb-1 font-medium">Medicamentos</label>
                            <input type="text" th:field="*{mascotas[__${iterStat.index}__].medicamentos}"
                                   class="w-full border rounded px-2 py-1"/>
                        </div>
                        <div>
                        <label class="block mb-1 font-medium">Condiciones médicas</label>
                        <input type="text"
                               th:field="*{mascotas[__${iterStat.index}__].condicionesMedicas}"
                               class="w-full border rounded px-2 py-1"/>
                    </div>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-2xl font-semibold mb-4">Autorizaciones</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block mb-1 font-medium">Autoriza Contacto Veterinario</label>
                    <input type="checkbox" th:field="*{autorizacionForm.autorizacionContactoVeterinario}"
                           class="form-checkbox h-5 w-5"/>
                </div>
                <div>
                    <label class="block mb-1 font-medium">Consentimiento Primeros Auxilios</label>
                    <input type="checkbox" th:field="*{autorizacionForm.consentimientoPrimerosAuxilios}"
                           class="form-checkbox h-5 w-5"/>
                </div>
                <div>
                    <label class="block mb-1 font-medium">Autoriza Uso de Imagen</label>
                    <input type="checkbox" th:field="*{autorizacionForm.autorizacionUsoImagen}"
                           class="form-checkbox h-5 w-5"/>
                </div>
                <div>
                    <label class="block mb-1 font-medium">Declaración de Responsabilidad</label>
                    <input type="checkbox" th:field="*{autorizacionForm.declaracionResponsabilidad}"
                           class="form-checkbox h-5 w-5"/>
                </div>
                <div>
                    <label class="block mb-1 font-medium">Autorizo Cuidado</label>
                    <input type="checkbox" th:field="*{autorizacionForm.autorizoCuidado}"
                           class="form-checkbox h-5 w-5"/>
                </div>
                <div>
                    <label class="block mb-1 font-medium">Autorizo Decisiones Médicas</label>
                    <input type="checkbox" th:field="*{autorizacionForm.autorizoDecisionesMedicas}"
                           class="form-checkbox h-5 w-5"/>
                </div>
                <div>
                    <label class="block mb-1 font-medium">Horarios de Entrada y Salida</label>
                    <input type="text" th:field="*{autorizacionForm.horariosEntradaSalida}"
                           class="w-full border rounded px-3 py-2"/>
                </div>
                <div>
                    <label class="block mb-1 font-medium">Tarifas y Pago</label>
                    <input type="text" th:field="*{autorizacionForm.tarifasYPago}"
                           class="w-full border rounded px-3 py-2"/>
                </div>
                <div>
                    <label class="block mb-1 font-medium">Fecha de Firma</label>
                    <input type="date"
                           th:field="*{autorizacionForm.fechaFirma}"
                           class="w-full border rounded px-3 py-2"/>
                </div>
            </div>
        </section>

        <section class="bg-white p-4 rounded-lg shadow mb-6">
            <h2 class="text-2xl font-semibold mb-3">Productos Seleccionados</h2>
            <div th:if="${not #lists.isEmpty(entryForm.productosSeleccionados)}" class="space-y-4">
                <div th:each="producto, prodStat : ${entryForm.productosSeleccionados}"
                     class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <input type="hidden" th:field="*{productosSeleccionados[__${prodStat.index}__].id}"/>
                    <input type="hidden" th:field="*{productosSeleccionados[__${prodStat.index}__].nombre}"/>
                    <input type="hidden" th:field="*{productosSeleccionados[__${prodStat.index}__].precio}"/>
                    <div class="flex-grow">
                        <span th:text="${producto.nombre}" class="font-medium"></span>
                        <span class="text-gray-600 ml-2">
                    $<span th:text="${#numbers.formatDecimal(producto.precio,0,2)}"></span>
                </span>
                    </div>
                    <button type="button"
                            th:onclick="'eliminarProducto(' + ${entryForm.id} + ',' + ${producto.id} + ')'"
                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </section>
        <section>
            <h2 class="text-2xl font-semibold mb-4">Servicio Actual</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block mb-1 font-medium">Servicio Seleccionado</label>
                    <input type="hidden" th:field="*{servicioSeleccionado.id}" />
                    <input type="text"
                           th:value="${entryForm.servicioSeleccionado != null ? entryForm.servicioSeleccionado.nombre : ''}"
                           class="w-full border rounded px-3 py-2"
                           readonly />
                </div>
                <div>
                    <label class="block mb-1 font-medium">Precio del Servicio</label>
                    <input type="text"
                           th:value="${entryForm.servicioSeleccionado != null ? #numbers.formatDecimal(entryForm.servicioSeleccionado.precio,0,2) : '0.00'}"
                           class="w-full border rounded px-3 py-2"
                           readonly />
                </div>
            </div>
        </section>
        <div class="text-xl font-bold">Total: $<span th:text="${#numbers.formatDecimal(total,0,2)}">0.00</span>
        </div>

        <div class="mt-6 flex justify-end">
            <button type="submit"
                    class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                Guardar Todos los Cambios
            </button>
        </div>
    </form>

    <section class="mt-8 bg-white p-6 rounded-lg shadow">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-xl font-semibold mb-2">Agregar Servicio</h3>
                    <form th:action="@{/moderador/EntradasYSalidas/editar/{id}/agregar-servicio(id=${entryForm.id})}"
                          method="post"
                          class="flex items-center space-x-2">
                        <input type="hidden" name="_csrf" th:value="${_csrf?.token}"/>
                        <select name="servicioId" class="flex-1 border rounded px-3 py-2">
                            <option value="">-- Seleccionar Servicio --</option>
                            <option th:each="serv : ${serviciosDisponibles}"
                                    th:value="${serv.id}"
                                    th:text="${serv.nombre} + ' - $' + ${#numbers.formatDecimal(serv.precio,0,2)}">
                            </option>
                        </select>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">
                            Agregar
                        </button>
                    </form>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-2">Agregar Producto</h3>
                    <form th:action="@{/moderador/EntradasYSalidas/editar/{id}/agregar-producto(id=${entryForm.id})}"
                          method="post"
                          class="flex items-center space-x-2">
                        <input type="hidden" name="_csrf" th:value="${_csrf?.token}"/>
                        <select name="productoId" class="flex-1 border rounded px-3 py-2">
                            <option value="">-- Seleccionar Producto --</option>
                            <option th:each="prod : ${productosDisponibles}"
                                    th:value="${prod.id}"
                                    th:text="${prod.nombre} + ' - $' + ${#numbers.formatDecimal(prod.precio,0,2)}">
                            </option>
                        </select>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                            Agregar
                        </button>
                    </form>
                </div>
            </div>
        </section>

</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const razasPorTipo = {
            Perro: ["Labrador", "Golden Retriever", "Poodle", "Bulldog", "Chihuahua"],
            Gato: ["Siames", "Persa", "Maine Coon", "Bengalí", "Esfinge"]
        };

        function actualizarRazas(sel) {
            const card = sel.closest('.mascota-card');
            const razaSel = card.querySelector('.raza-select');
            const prev = razaSel.getAttribute('data-selected') || '';
            razaSel.innerHTML = '<option value="">Seleccione</option>';
            (razasPorTipo[sel.value] || []).forEach(r => {
                const o = document.createElement('option');
                o.value = r;
                o.text = r;
                if (r === prev) o.selected = true;
                razaSel.appendChild(o);
            });
        }

        document.querySelectorAll('.tipo-animal-select').forEach(s => {
            actualizarRazas(s);
            s.addEventListener('change', () => actualizarRazas(s));
        });
    });
    function eliminarProducto(entryFormId, productoId) {
        if (confirm('¿Estás seguro de eliminar este producto?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/moderador/EntradasYSalidas/editar/${entryFormId}/eliminar-producto`;

            const csrfToken = document.querySelector('input[name="_csrf"]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_csrf';
            csrfInput.value = csrfToken;

            const productoIdInput = document.createElement('input');
            productoIdInput.type = 'hidden';
            productoIdInput.name = 'productoId';
            productoIdInput.value = productoId;

            form.appendChild(csrfInput);
            form.appendChild(productoIdInput);
            document.body.appendChild(form);
            form.submit();
        }
    }

</script>
</body>
</html>